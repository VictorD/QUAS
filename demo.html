<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="css/main.css">

<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
<script src="js/jquery.history.js"></script>
<script src="js/pager.js"></script>

<title>QUAS - Your LTU knowledge database !</title>
</head>
<body>
<div class="container">
<div class="row">
<div id="header" class="col-md-12 column">
<ul id="nav-menu">
   <li>QUAS</li>
   <li><a class="blue">Questions</a></li>
   <li><a>Sign in</a></li>
</ul>   
</div>
<!--<textarea id="log" style="width:100%;height:400px"></textarea>-->

<ul data-bind="foreach: questions">
    <li class="question">
      <a href="#" data-bind="click: $parent.viewQuestion, text: title"></a>
      <span data-bind="text: title"></span>
      <span data-bind="text: body"></span>
      <a href="#" data-bind="text: tags"></a>
   </li>
</ul>

<hr/>
<div id="questionView" class="row" data-bind="with: viewedQuestion">
   <div class="col-lg-6 col-lg-offset-3" id="add">
   <h1>Viewing Question <span data-bind="text: id"></span></h1>
   <span  data-bind="text:title"></span>
   <p data-bind="text: timestamp"></p>
   <p id="question-body" data-bind="text: body"></p>
   <p>Tags: <span data-bind="text: tags"></span></p>   
   <h3>Replies: </h3>
   <table>
   <tbody>
   <!-- ko foreach: replies -->
   <tr class="replyList">
     <td data-bind="text: timestamp"></td>
     <td data-bind="text: body"></td>
   </tr>
   <!-- /ko -->
   </tbody> 
   </table>
   <br/>
   <p>
       <button id="deleteQuestion" href="#">Delete question</button>
   </p>
</div>

<script>
window.backendURL = 'http://130.240.5.168:5000';

var Question = function(data) {
   this.id        = ko.observable();
   this.body      = ko.observable("Loading question...");
   this.title     = ko.observable("Title placeholder");
   this.id        = ko.observable();
   this.tags      = ko.observable();
   this.timestamp = ko.observable();
   this.replies   = ko.observableArray();

   // Populate our model with the initial data
   this.update(data);
};

//can pass fresh data to this function at anytime to apply updates or revert to a prior version
Question.prototype.update = function(data) {
   this.id(data.id);
   this.body(data.body);
   this.title(data.title);
   this.id(data.id);
   this.tags(data.tags);
   this.timestamp(data.timestamp);
};

var ViewModel = function() {
   this.questions = ko.observableArray();
   
   this.viewedQuestion = ko.observable();
    
   this.viewQuestion = this.viewQuestion.bind(this);
   //this.acceptItem = this.acceptItem.bind(this);
   //this.revertItem = this.revertItem.bind(this);

   var q = {id:1, body: "look at that body", title: "Dummy question", tags: "tags", timestamp: "timestamp 2013"};
   
   this.questions.push(new Question(q));
   /*$.getJSON(window.backendURL + '/questions/').done(function(data) {
      console.log("We are in ajax();");
      var ql = data.QuestionList;
      for (var i = 0; i < ql.length; i++) {
         window.questions.push(new Question(ql[i]));
      }
   });*/

};

ko.utils.extend(ViewModel.prototype, {
   viewQuestion: function(question) {

      var questionId = ko.toJS(question.id);
      // Load replies if not yet done so.
   
      question.replies([]);
      question.replies.push({body: 'random reply', id: Math.random(), timestamp: "TIMESTAMP"});
      /*$.getJSON(window.backendURL + "/questions/" + questionId + "/replies/").done(function(data) {
         question.replies([]);
         console.log("Loading replies for question: " + questionId);
         var rl = data.ReplyList;
         for (var i = 0; i < rl.length; i++) {
            question.replies.push({				
            body: ko.observable(rl[i].body),
            id: ko.observable(rl[i].id),
            timestamp: ko.observable(rl[i].timestamp)
           });
         } 
      });*/

      History.pushState({questionId:questionId}, null, "?question=" + questionId);
   }
});

function getQuestionById(id) {
   return $.grep(vm.questions(), function(q) { return q.id() == id; });
}

// Establish Variables
var State = History.getState();


// Log Initial State
//var $log = $('#log');
History.log('initial:', State.data, State.title, State.url);

// Bind to State Change
History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
   // Log the State
   var State = History.getState(); // Note: We are using History.getState() instead of event.state
   History.log('statechange:', State.data, State.title, State.url);
   History.log('questionId: ', State.data.questionId);

   vm.viewedQuestion(getQuestionById(State.data.questionId)[0]);
});

// use HTML5 history
pager.useHTML5history = true;
// use History instead of history
pager.Href5.history = History;

pager.Href.hash = '#!/';

var vm = new ViewModel();
pager.extendWithPage(vm);
ko.applyBindings(vm);
pager.startHistoryJs();

</script>
</body>
</html>