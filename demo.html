<html>
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="css/main.css">

<script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
<script src="js/jquery.history.js"></script>
<script src="js/knockout-3.0.0.js"></script>
<script src="js/pager.js"></script>

<title>QUAS - Your LTU knowledge database !</title>
</head>
<body>
<div class="container">
<div class="row">
<div id="header" class="col-md-12 column">
<ul id="nav-menu">
   <li style="width: 80px;text-align: left;">QUAS</li>
   
   <li class="blue">
      <span style="color: #eee;" class="glyphicon glyphicon-question-sign"></span>
      <span style="color: #eee;">Questions</span>
      <span class="glyphicon glyphicon-arrow-down" style="position:absolute;top:60px;left: 205px;z-index:999;"></span>
   </li>
   <li class="orange"><span class="glyphicon glyphicon-search"></span><span> Search</span></li>
   <li style="float: right;"><a href="http://130.240.5.168:5000/u/login">Sign in</a></li>
  
</ul>   
</div>
</div>
<div class="row">
   <div class="col-md-6" style="padding-left: 0;">
   <div id="nav-filter-menu">
      <span class="glyphicon glyphicon-list-alt"></span>&nbsp;<span>Filter questions</span>
   </div>
   <ul id="question-list" data-bind="foreach: questions">
       <li class="question-block clearfix" data-bind="style: isQuestionSelected(id) ? { background: '#b9ecff' } : { background: '#eee'}">
         <!--<img src=""/>-->
         <div style="background-color: #aaa;width:64px;height:64px;float: left;margin-top: 10px;margin-right: 15px;"></div>
         <ul>
            <li class="question-header">
               <span class="author">AuthorName asked at <span class="timestamp" data-bind="text:timestamp"></span></span>:
            </li>
            <li class="question-body">
               <a href="#" data-bind="click: $parent.viewQuestion, text: title"></a>
            </li>
            <li class="question-tags">
               <a href="#" data-bind="text: tags"></a>
            </li>
         </ul>
      </li>
   </ul>
   
   </div>

   <div id="questionView" class="col-md-6 column" data-bind="with: viewedQuestion, fadeVisible: isViewingQuestion()">
         <h1>Viewing Question <span data-bind="text: id"></span></h1>
         <span  data-bind="text:title"></span>
         <p data-bind="text: timestamp"></p>
         <p id="question-body" data-bind="text: body"></p>
         <p>Tags: <span data-bind="text: tags"></span></p>   
         <h3>Replies: </h3>
         <table>
         <tbody>
         <!-- ko foreach: replies -->
         <tr class="replyList">
           <td data-bind="text: timestamp"></td>
           <td data-bind="text: body"></td>
         </tr>
         <!-- /ko -->
         </tbody> 
         </table>
         <br/>
         <p>
             <button id="deleteQuestion" href="#">Delete question</button>
         </p>
      </div>
   </div>
</div>
<script>
window.backendURL = 'http://130.240.5.168:5000';

var Question = function(data) {
   this.id        = ko.observable();
   this.body      = ko.observable("Loading question...");
   this.title     = ko.observable("Title placeholder");
   this.id        = ko.observable();
   this.tags      = ko.observable();
   this.timestamp = ko.observable("undefined time");
   this.replies   = ko.observableArray();
   this.update(data);
};

Question.prototype.update = function(data) {
   this.id(data.id);
   this.body(data.body);
   this.title(data.title);
   this.id(data.id);
   this.tags(data.tags);
   this.timestamp(data.timestamp);
};

var ViewModel = function() {
   this.questions = ko.observableArray();
   
   this.isViewingQuestion = function() { return (vm.viewedQuestion() != undefined); }
   this.viewedQuestion = ko.observable();
    
   this.viewQuestion = this.viewQuestion.bind(this);

   /*for (var i=0;i<5;i++)
   { 
      var q = {id:i, body: "look at that body", title: "Is this dummy question #" + i + "?", tags: "#demo #2013 #notreallyaquestion", timestamp: 'timestamp 2013'};
      this.questions.push(new Question(q));
   }*/

   self = this;
   $.getJSON(window.backendURL + '/questions/').done(function(data) {
      console.log("We are in ajax();");
      var ql = data.QuestionList;
      for (var i = 0; i < ql.length; i++) {
         self.questions.push(new Question(ql[i]));
      }
   });

};

ko.utils.extend(ViewModel.prototype, {
   viewQuestion: function(question) {

      var questionId = ko.toJS(question.id);
      // Load replies if not yet done so.
   
      question.replies([]);
      question.replies.push({body: 'random reply', id: Math.random(), timestamp: "TIMESTAMP"});
      $.getJSON(window.backendURL + "/questions/" + questionId + "/replies/").done(function(data) {
         question.replies([]);
         console.log("Loading replies for question: " + questionId);
         var rl = data.ReplyList;
         for (var i = 0; i < rl.length; i++) {
            question.replies.push({				
            body: ko.observable(rl[i].body),
            id: ko.observable(rl[i].id),
            timestamp: ko.observable(rl[i].timestamp)
           });
         } 
      });

      History.pushState({state:questionId, rnd:Math.random()}, null, "?question=" + questionId);
   }
});

// Here's a custom Knockout binding that makes elements shown/hidden via jQuery's fadeIn()/fadeOut() methods
// Could be stored in a separate utility library
ko.bindingHandlers.fadeVisible = {
    init: function(element, valueAccessor) {
        $(element).hide();
         
        var value = valueAccessor();
        ko.unwrap(value) ? $(element).fadeIn() : $(element).fadeOut();
    },
    update: function(element, valueAccessor) {
        $(element).hide();
        // Whenever the value subsequently changes, slowly fade the element in or out
        var value = valueAccessor();
        ko.unwrap(value) ? $(element).fadeIn() : $(element).fadeOut();
    }
};

function getQuestionById(id) {
   return $.grep(vm.questions(), function(q) { return q.id() == id; });
}

function isQuestionSelected(id) {

   return (vm.viewedQuestion() != undefined && vm.viewedQuestion().id() == id());
}

// Establish Variables
var State = History.getState();

// Bind to State Change
History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
   var State = History.getState(); // Note: We are using History.getState() instead of event.state
   //History.log('statechange:', State.data, State.title, State.url);
   //History.log('questionId: ', State.data.state);

   vm.viewedQuestion(getQuestionById(State.data.state)[0]);
});

// use HTML5 history
pager.useHTML5history = true;
// use History instead of history
pager.Href5.history = History;

pager.Href.hash = '#!/';

var vm = new ViewModel();
pager.extendWithPage(vm);
ko.applyBindings(vm);
pager.startHistoryJs();

</script>
</body>
</html>
